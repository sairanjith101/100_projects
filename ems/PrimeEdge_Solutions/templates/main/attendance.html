{% extends 'main/base.html' %}
{% load static %}
{% block title %} Prime Edge Solutions | Dashboard {% endblock title %}
{% block content %}
<link
  rel="stylesheet"
  type="text/css"
  href="{% static 'css/attendance.css' %}"
/>
<link
  href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css"
  rel="stylesheet"
/>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

<section class="attendance-section">
  <div class="container">
    <h2 id="att">Attendance</h2>

    <!-- Current Day Attendance -->
    <h3>Today's Attendance</h3>
    <table class="attendance-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Check In</th>
          <th>Check Out</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>{{ attendance.date }}</td>
          <td>
            {% if not attendance.check_in_time %}
            <form method="post" action="{% url 'attendance' %}">
              {% csrf_token %}
              <button type="submit" name="check_in" class="btn btn-primary">
                Check In
              </button>
            </form>
            {% else %} {{ attendance.check_in_time }} {% endif %}
          </td>
          <td>
            {% if attendance.check_in_time and not attendance.check_out_time %}
            <form method="post" action="{% url 'attendance' %}">
              {% csrf_token %}
              <button type="submit" name="check_out" class="btn btn-secondary">
                Check Out
              </button>
            </form>
            {% elif attendance.check_out_time %} {{ attendance.check_out_time }}
            {% else %} <em>Not Checked In</em> {% endif %}
          </td>
        </tr>
      </tbody>
    </table>

    <!-- View Toggle -->
    <div class="view-toggle">
      <a
        href="{% url 'attendance' %}?view=table"
        class="btn btn-toggle {% if view_type == 'table' %}active{% endif %}"
      >Table View</a>
      <a
        href="{% url 'attendance' %}?view=calendar"
        class="btn btn-toggle {% if view_type == 'calendar' %}active{% endif %}"
      >Calendar View</a>
    </div>

    <!-- Previous Attendance Records -->
    {% if view_type == 'table' %}
    <h3>Previous Attendance Records (Table View)</h3>
    <table class="attendance-table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Check In</th>
          <th>Check Out</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
        {% for record in attendance_records %}
        <tr>
          <td>{{ record.date }}</td>
          <td>{{ record.check_in_time|default:"Not Checked In" }}</td>
          <td>{{ record.check_out_time|default:"Not Checked Out" }}</td>
          <td>{{ record.status }}</td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4">No previous attendance records found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% elif view_type == 'calendar' %}
    <h3>Previous Attendance Records (Calendar View)</h3>
    <!-- Calendar View Implementation -->
    <div id="calendar" class="calendar"></div>
    {% endif %}
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      events: [
        {% for record in attendance_records %}
        {
          title: '{{ record.status|escapejs }}',
          start: '{{ record.date|date:"Y-m-d" }}',
          end: '{{ record.date|date:"Y-m-d" }}',
          // Color logic handled in JavaScript
          color: '{{ record.status|escapejs }}' // Pass status data for color logic
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
      ],
      height: 'auto' // Adjust height as needed
    });

    // Color logic for calendar events
    calendar.on('eventDidMount', function(info) {
      if (info.event._def.extendedProps.color === 'Present') {
        info.el.style.backgroundColor = '#28a745'; // Green for present
      } else {
        info.el.style.backgroundColor = '#dc3545'; // Red for absent
      }
    });

    calendar.render();
  });
</script>
{% endblock %}
